# 智能数据库路由功能说明

## 🎯 功能概述

我们成功实现了智能数据库路由功能，当用户选择错误的数据库时，系统能够自动判断并建议切换到正确的数据库，从而确保查询能够正确执行。

## 🚀 核心特性

### 1. 智能问题识别
系统能够根据问题内容自动识别应该使用哪个数据库：

- **医疗数据库关键词**：医生、病人、患者、诊疗、诊断、处方、科室、职称等
- **仓储数据库关键词**：库存、商品、产品、仓库、员工、出入库、供应商、价格等

### 2. 自动数据库建议
当用户的问题与当前数据库不匹配时，系统会：
- 识别问题类型
- 建议切换到正确的数据库
- 提供清晰的切换指导

### 3. 无缝用户体验
- 用户可以选择手动切换数据库
- 系统会在查询时自动检查数据库匹配性
- 提供友好的错误提示和解决建议

## 🔧 技术实现

### 模型路由逻辑 (`app/llm/router.py`)

```python
def suggest_database(self, question: str) -> str:
    """根据问题内容建议合适的数据库"""
    q = question.lower().strip()
    
    # 医疗数据库关键词
    hospital_keywords = [
        "医生", "病人", "患者", "诊疗", "诊断", "处方", "科室", "职称",
        "doctors", "patients", "medical_records", "department", "title"
    ]
    
    # 仓储数据库关键词
    warehouse_keywords = [
        "库存", "商品", "产品", "仓库", "员工", "出入库", "供应商", "价格",
        "products", "inventory", "warehouse_staff", "shipments", "supplier", "price"
    ]
    
    if any(k in q for k in warehouse_keywords):
        return "warehouse"
    elif any(k in q for k in hospital_keywords):
        return "hospital"
    else:
        return "unknown"  # 无法确定，使用当前数据库
```

### 智能查询处理 (`app/main.py`)

```python
async def _handle_database_query(payload: ChatRequest, user_role: str, db_type: str, db: Session) -> ChatResponse:
    try:
        # 1. 检查是否需要切换数据库
        suggested_db = model_router.suggest_database(payload.question)
        if suggested_db != "unknown" and suggested_db != db_type:
            # 建议切换到其他数据库
            return ChatResponse(
                answer=f"您的问题与当前数据库不匹配。建议切换到{suggested_db == 'warehouse' and '仓储' or '医疗'}数据库来查询相关信息。\n\n当前数据库：{db_type == 'warehouse' and '仓储' or '医疗'}数据库\n建议数据库：{suggested_db == 'warehouse' and '仓储' or '医疗'}数据库\n\n请在左侧面板切换数据库后重新提问。",
                meta={
                    "suggestion": f"switch_to_{suggested_db}",
                    "current_db": db_type,
                    "suggested_db": suggested_db,
                    "role": user_role
                }
            )
        
        # 2. 继续正常的查询处理...
```

## 📊 使用示例

### 示例1：在医疗数据库下询问仓储问题

**请求**：
```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "D101", 
    "question": "查询所有笔记本电脑的库存数量", 
    "model_type": "cloud", 
    "cloud_model": "deepseek-chat"
  }'
```

**响应**：
```json
{
  "answer": "您的问题与当前数据库不匹配。建议切换到仓储数据库来查询相关信息。\n\n当前数据库：医疗数据库\n建议数据库：仓储数据库\n\n请在左侧面板切换数据库后重新提问。",
  "meta": {
    "suggestion": "switch_to_warehouse",
    "current_db": "hospital",
    "suggested_db": "warehouse",
    "role": "doctor"
  }
}
```

### 示例2：在仓储数据库下询问医疗问题

**请求**：
```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "S1001", 
    "question": "查询所有心内科的医生信息", 
    "model_type": "cloud", 
    "cloud_model": "deepseek-chat"
  }'
```

**响应**：
```json
{
  "answer": "您的问题与当前数据库不匹配。建议切换到医疗数据库来查询相关信息。\n\n当前数据库：仓储数据库\n建议数据库：医疗数据库\n\n请在左侧面板切换数据库后重新提问。",
  "meta": {
    "suggestion": "switch_to_hospital",
    "current_db": "warehouse",
    "suggested_db": "hospital",
    "role": "Operator"
  }
}
```

### 示例3：在正确数据库下查询

**医疗数据库查询**：
```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "D101", 
    "question": "查询所有心内科的医生信息", 
    "model_type": "cloud", 
    "cloud_model": "deepseek-chat"
  }'
```

**响应**：
```json
{
  "answer": "查询到2位心内科的医生信息：\n\n1. 王建国医生，主任医师，工号D101\n2. 赵静医生，住院医师，工号D104",
  "meta": {
    "sql": "SELECT * FROM doctors WHERE department = '心内科';",
    "role": "doctor",
    "permission": true,
    "result_count": 2,
    "database": "hospital",
    "sql_model": "cloud_api",
    "answer_model": "cloud_api"
  }
}
```

**仓储数据库查询**：
```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "S1001", 
    "question": "查询所有笔记本电脑的库存数量", 
    "model_type": "cloud", 
    "cloud_model": "deepseek-chat"
  }'
```

**响应**：
```json
{
  "answer": "当前库存中共有75台笔记本电脑，存放位置在A区-01架。",
  "meta": {
    "sql": "SELECT i.quantity, i.warehouse_location FROM inventory i JOIN products p ON i.product_id = p.product_id WHERE p.product_name LIKE '%笔记本电脑%';",
    "role": "Operator",
    "permission": true,
    "result_count": 1,
    "database": "warehouse",
    "sql_model": "cloud_api",
    "answer_model": "cloud_api"
  }
}
```

## 🎨 前端集成

### 模型选择面板
前端界面已经集成了模型选择功能，用户可以：
- 选择模型类型（自动选择、本地模型、云端模型）
- 选择具体的云端模型（DeepSeek R1、DeepSeek Chat、GPT-4o Mini）
- 查看模型状态和可用性

### 数据库切换
- 左侧面板提供数据库切换控制
- 支持医疗数据库和仓储数据库之间的切换
- 实时显示当前激活的数据库

## 🔍 关键词识别规则

### 医疗数据库关键词
- **中文**：医生、病人、患者、诊疗、诊断、处方、科室、职称
- **英文**：doctors、patients、medical_records、department、title

### 仓储数据库关键词
- **中文**：库存、商品、产品、仓库、员工、出入库、供应商、价格
- **英文**：products、inventory、warehouse_staff、shipments、supplier、price

## 💡 使用建议

### 1. 用户操作流程
1. 在左侧面板选择要查询的数据库类型
2. 选择用户角色
3. 输入问题开始查询
4. 如果系统提示数据库不匹配，按照建议切换到正确的数据库

### 2. 最佳实践
- 根据问题类型预先选择正确的数据库
- 利用系统的智能建议功能
- 在查询前确认数据库和角色设置

### 3. 故障排除
- 如果查询失败，检查数据库选择是否正确
- 查看系统建议的数据库类型
- 确认用户角色权限

## 🎉 功能优势

1. **智能识别**：自动识别问题类型和所需数据库
2. **用户友好**：提供清晰的切换建议和操作指导
3. **无缝体验**：支持手动选择和自动建议
4. **错误预防**：避免在错误数据库下执行查询
5. **性能优化**：确保查询在正确的数据库上执行

## 🔮 未来扩展

- [ ] 支持更多数据库类型
- [ ] 智能数据库推荐算法优化
- [ ] 用户查询历史分析
- [ ] 自动数据库切换功能
- [ ] 查询性能监控和优化建议

---

**总结**：我们成功实现了智能数据库路由功能，用户现在可以：
- 手动选择数据库
- 获得智能的数据库匹配建议
- 享受更流畅的查询体验
- 避免在错误数据库下执行查询

系统现在更加智能和用户友好！
